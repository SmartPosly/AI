<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Deployed Registration System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            background: #f9f9f9;
        }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #005a87; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .result { 
            background: #fff; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            white-space: pre-wrap; 
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üöÄ Test Deployed Registration System</h1>
    <p>Use this page to test the registration system on your live website.</p>
    
    <div class="test-section">
        <h2>üìä System Status Check</h2>
        <button onclick="checkSystemStatus()">Check All APIs</button>
        <div id="status-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>üìù Test Registration</h2>
        <div class="form-group">
            <label>Name:</label>
            <input type="text" id="test-name" value="Test User" placeholder="Enter test name">
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="test-email" placeholder="test@example.com">
        </div>
        <div class="form-group">
            <label>Phone:</label>
            <input type="tel" id="test-phone" value="0912345678" placeholder="0912345678">
        </div>
        <div class="form-group">
            <label>Experience:</label>
            <select id="test-experience">
                <option value="beginner">ŸÖÿ®ÿ™ÿØÿ¶</option>
                <option value="intermediate">ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                <option value="advanced">ŸÖÿ™ŸÇÿØŸÖ</option>
            </select>
        </div>
        <button onclick="testRegistration()">Submit Test Registration</button>
        <div id="registration-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>üë• Check Admin Panel Data</h2>
        <button onclick="checkAdminData()">Load Admin Panel Data</button>
        <button onclick="syncData()">Force Data Sync</button>
        <div id="admin-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>üîÑ Data Management</h2>
        <button onclick="viewAllData()">View All Data Sources</button>
        <button onclick="clearLocalData()">Clear Local Data</button>
        <button class="danger" onclick="resetSystem()">Reset Entire System</button>
        <div id="data-result" class="result"></div>
    </div>

    <script>
        // Generate unique email for testing
        function generateTestEmail() {
            return 'test' + Date.now() + '@example.com';
        }
        
        // Set unique email on page load
        window.onload = function() {
            document.getElementById('test-email').value = generateTestEmail();
            checkSystemStatus();
        };
        
        async function checkSystemStatus() {
            const result = document.getElementById('status-result');
            result.innerHTML = 'Checking system status...';
            result.className = 'result info';
            
            const checks = [];
            
            // Test registration API
            try {
                const regResponse = await fetch('/api/register', { method: 'GET' });
                checks.push({
                    name: 'Registration API',
                    status: regResponse.status,
                    success: regResponse.ok,
                    details: regResponse.ok ? 'Available' : 'Error'
                });
            } catch (error) {
                checks.push({
                    name: 'Registration API',
                    status: 'Error',
                    success: false,
                    details: error.message
                });
            }
            
            // Test shared data API
            try {
                const sharedResponse = await fetch('/api/shared-data');
                const sharedData = await sharedResponse.json();
                checks.push({
                    name: 'Shared Data API',
                    status: sharedResponse.status,
                    success: sharedResponse.ok,
                    details: sharedData.success ? `${sharedData.count} registrations` : sharedData.message
                });
            } catch (error) {
                checks.push({
                    name: 'Shared Data API',
                    status: 'Error',
                    success: false,
                    details: error.message
                });
            }
            
            // Test users API
            try {
                const usersResponse = await fetch('/api/users');
                const usersData = await usersResponse.json();
                checks.push({
                    name: 'Users API',
                    status: usersResponse.status,
                    success: usersResponse.ok,
                    details: usersData.success ? 'Available' : usersData.message
                });
            } catch (error) {
                checks.push({
                    name: 'Users API',
                    status: 'Error',
                    success: false,
                    details: error.message
                });
            }
            
            // Check localStorage
            const localData = localStorage.getItem('registrations');
            checks.push({
                name: 'Local Storage',
                status: 'OK',
                success: true,
                details: localData ? `${JSON.parse(localData).length} registrations` : 'Empty'
            });
            
            const allSuccess = checks.every(check => check.success);
            result.className = 'result ' + (allSuccess ? 'success' : 'error');
            result.innerHTML = `System Status Check (${new Date().toLocaleTimeString()}):

${checks.map(check => 
    `${check.success ? '‚úÖ' : '‚ùå'} ${check.name}: ${check.status} - ${check.details}`
).join('\n')}

Overall Status: ${allSuccess ? '‚úÖ All systems operational' : '‚ö†Ô∏è Some issues detected'}`;
        }
        
        async function testRegistration() {
            const result = document.getElementById('registration-result');
            result.innerHTML = 'Submitting test registration...';
            result.className = 'result info';
            
            const testData = {
                name: document.getElementById('test-name').value,
                email: document.getElementById('test-email').value,
                phone: document.getElementById('test-phone').value,
                experience: document.getElementById('test-experience').value,
                interests: ['prompting', 'coding'],
                hearAbout: 'Test Page',
                notes: 'Test registration from deployment test page'
            };
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                result.className = 'result ' + (response.ok ? 'success' : 'error');
                result.innerHTML = `Registration Test Result:
Status: ${response.status}
Success: ${data.success}
Message: ${data.message}
${data.user ? 'User ID: ' + data.user.id : ''}
${data.totalRegistrations ? 'Total Registrations: ' + data.totalRegistrations : ''}

Response Data:
${JSON.stringify(data, null, 2)}`;
                
                // Generate new email for next test
                document.getElementById('test-email').value = generateTestEmail();
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Registration Error: ${error.message}`;
            }
        }
        
        async function checkAdminData() {
            const result = document.getElementById('admin-result');
            result.innerHTML = 'Loading admin panel data...';
            result.className = 'result info';
            
            try {
                // Check shared data
                const sharedResponse = await fetch('/api/shared-data');
                const sharedData = await sharedResponse.json();
                
                // Check local data
                const localData = localStorage.getItem('registrations');
                const parsedLocal = localData ? JSON.parse(localData) : [];
                
                result.className = 'result success';
                result.innerHTML = `Admin Panel Data Check:

Shared Data API:
- Status: ${sharedResponse.status}
- Count: ${sharedData.success ? sharedData.count : 'Error'}
- Data: ${sharedData.success ? JSON.stringify(sharedData.registrations, null, 2) : sharedData.message}

Local Storage:
- Count: ${parsedLocal.length}
- Data: ${JSON.stringify(parsedLocal, null, 2)}

Summary:
- Shared API has ${sharedData.success ? sharedData.count : 0} registrations
- Local storage has ${parsedLocal.length} registrations
- Admin panel should show the combined/synced data`;
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Error checking admin data: ${error.message}`;
            }
        }
        
        async function syncData() {
            const result = document.getElementById('admin-result');
            result.innerHTML = 'Syncing data...';
            result.className = 'result info';
            
            try {
                // Get local data
                const localData = localStorage.getItem('registrations');
                const parsedLocal = localData ? JSON.parse(localData) : [];
                
                if (parsedLocal.length > 0) {
                    // Sync to shared API
                    const syncResponse = await fetch('/api/shared-data', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ registrations: parsedLocal })
                    });
                    
                    const syncData = await syncResponse.json();
                    
                    result.className = 'result ' + (syncResponse.ok ? 'success' : 'error');
                    result.innerHTML = `Data Sync Result:
Status: ${syncResponse.status}
Success: ${syncData.success}
Message: ${syncData.message}
Synced Count: ${syncData.count}`;
                } else {
                    result.className = 'result info';
                    result.innerHTML = 'No local data to sync';
                }
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Sync error: ${error.message}`;
            }
        }
        
        async function viewAllData() {
            const result = document.getElementById('data-result');
            result.innerHTML = 'Loading all data sources...';
            result.className = 'result info';
            
            try {
                // Get shared data
                const sharedResponse = await fetch('/api/shared-data');
                const sharedData = await sharedResponse.json();
                
                // Get local data
                const localData = localStorage.getItem('registrations');
                const resetFlag = localStorage.getItem('registrationsReset');
                
                result.className = 'result info';
                result.innerHTML = `All Data Sources:

=== SHARED DATA API ===
Status: ${sharedResponse.status}
Success: ${sharedData.success}
Count: ${sharedData.success ? sharedData.count : 'Error'}
Data: ${JSON.stringify(sharedData.registrations || [], null, 2)}

=== LOCAL STORAGE ===
Registrations: ${localData || 'null'}
Reset Flag: ${resetFlag || 'null'}
Parsed Count: ${localData ? JSON.parse(localData).length : 0}

=== SUMMARY ===
Total unique registrations: ${sharedData.success ? sharedData.count : 0}
Local backup count: ${localData ? JSON.parse(localData).length : 0}
System status: ${sharedData.success ? 'Operational' : 'Issues detected'}`;
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Error viewing data: ${error.message}`;
            }
        }
        
        function clearLocalData() {
            const result = document.getElementById('data-result');
            
            localStorage.removeItem('registrations');
            localStorage.removeItem('registrationsReset');
            sessionStorage.removeItem('registrationsReset');
            
            result.className = 'result success';
            result.innerHTML = 'Local data cleared successfully!';
        }
        
        async function resetSystem() {
            if (!confirm('Are you sure you want to reset the entire system? This will clear all registration data!')) {
                return;
            }
            
            const result = document.getElementById('data-result');
            result.innerHTML = 'Resetting entire system...';
            result.className = 'result info';
            
            try {
                // Clear shared data
                const clearResponse = await fetch('/api/shared-data', {
                    method: 'DELETE'
                });
                const clearData = await clearResponse.json();
                
                // Clear local data
                localStorage.removeItem('registrations');
                localStorage.removeItem('registrationsReset');
                sessionStorage.removeItem('registrationsReset');
                
                result.className = 'result success';
                result.innerHTML = `System Reset Complete:
Shared Data: ${clearData.success ? 'Cleared' : 'Error'}
Local Storage: Cleared
Session Storage: Cleared
Previous Count: ${clearData.previousCount || 0}

The system has been completely reset.`;
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Reset error: ${error.message}`;
            }
        }
    </script>
</body>
</html>