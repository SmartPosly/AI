<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Registration Flow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Test Registration Flow</h1>
    
    <div class="test-section">
        <h2>1. Check Current localStorage State</h2>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <div id="localStorage-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Registration API</h2>
        <button onclick="testRegistrationAPI()">Test Registration</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Users API</h2>
        <button onclick="testUsersAPI()">Test Users API</button>
        <div id="users-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Simulate Registration</h2>
        <button onclick="simulateRegistration()">Simulate Registration</button>
        <div id="simulate-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Clear All Data</h2>
        <button onclick="clearAllData()">Clear All Data</button>
        <div id="clear-result" class="result"></div>
    </div>

    <script>
        function checkLocalStorage() {
            const result = document.getElementById('localStorage-result');
            const registrations = localStorage.getItem('registrations');
            const resetFlag = localStorage.getItem('registrationsReset');
            const sessionResetFlag = sessionStorage.getItem('registrationsReset');
            
            result.innerHTML = `
                <strong>localStorage State:</strong><br>
                - registrations: ${registrations || 'null'}<br>
                - registrationsReset: ${resetFlag || 'null'}<br>
                - sessionStorage.registrationsReset: ${sessionResetFlag || 'null'}<br>
                <br>
                <strong>Parsed registrations:</strong><br>
                ${registrations ? JSON.stringify(JSON.parse(registrations), null, 2) : 'No data'}
            `;
        }
        
        async function testRegistrationAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML = 'Testing...';
            
            const testData = {
                name: 'Test User',
                email: 'test@example.com',
                phone: '0912345678',
                experience: 'beginner',
                interests: ['prompting'],
                hearAbout: 'Test',
                notes: 'Test registration'
            };
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                result.innerHTML = `
                    <strong>API Response:</strong><br>
                    Status: ${response.status}<br>
                    Success: ${data.success}<br>
                    Message: ${data.message}<br>
                    User: ${JSON.stringify(data.user, null, 2)}
                `;
            } catch (error) {
                result.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function testUsersAPI() {
            const result = document.getElementById('users-result');
            result.innerHTML = 'Testing...';
            
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                result.innerHTML = `
                    <strong>Users API Response:</strong><br>
                    Status: ${response.status}<br>
                    Data: ${JSON.stringify(data, null, 2)}
                `;
            } catch (error) {
                result.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        async function simulateRegistration() {
            const result = document.getElementById('simulate-result');
            result.innerHTML = 'Simulating...';
            
            // Clear reset flags first
            localStorage.removeItem('registrationsReset');
            sessionStorage.removeItem('registrationsReset');
            
            const testUser = {
                id: Date.now(),
                name: 'Simulated User',
                email: 'simulated@example.com',
                phone: '+218 91 234 5678',
                experience: 'intermediate',
                interests: ['prompting', 'coding'],
                hearAbout: 'Simulation',
                notes: 'This is a simulated registration',
                registrationDate: new Date().toISOString()
            };
            
            try {
                // Get existing data
                let existingData = [];
                const storedData = localStorage.getItem('registrations');
                if (storedData) {
                    existingData = JSON.parse(storedData);
                    if (!Array.isArray(existingData)) existingData = [];
                }
                
                // Add new user
                existingData.push(testUser);
                localStorage.setItem('registrations', JSON.stringify(existingData));
                
                result.innerHTML = `
                    <strong>Simulation Complete:</strong><br>
                    Added user: ${testUser.name}<br>
                    Total registrations: ${existingData.length}<br>
                    <br>
                    <strong>Current localStorage:</strong><br>
                    ${JSON.stringify(existingData, null, 2)}
                `;
            } catch (error) {
                result.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
        
        function clearAllData() {
            const result = document.getElementById('clear-result');
            
            localStorage.removeItem('registrations');
            localStorage.removeItem('registrationsReset');
            sessionStorage.removeItem('registrationsReset');
            
            result.innerHTML = '<strong>All data cleared!</strong>';
        }
        
        // Auto-check localStorage on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>